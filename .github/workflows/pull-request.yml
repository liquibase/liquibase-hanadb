name: Run Unit Tests

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize

jobs:
  unit-test:
    name: Java ${{ matrix.java }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java: [8, 11, 17]

    steps:
      - uses: actions/checkout@v2
      - name: Cache Local Maven Repository
        uses: actions/cache@v2
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v2
        with:
          java-version: ${{ matrix.java }}
          distribution: 'adopt'
      - name: Run Unit Tests With Maven
        run: mvn -B clean test package

      - name: Archive Test Results
        if: ${{ always() }}
        uses: actions/upload-artifact@v2
        with:
          name: test-reports-jdk${{ matrix.java }}
          path: ./**/target/surefire-reports

      - name: Save Artifacts
        uses: actions/upload-artifact@v2
        with:
          name: liquibase-hanadb
          path: |
            target/*.jar

  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: unit-test
    steps:
      - uses: actions/checkout@v2

      - name: Set up JDK 8
        uses: actions/setup-java@v2
        with:
          java-version: '8'
          distribution: 'adopt'

      - name: Login to Hana Docker
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HANADB_USERNAME }}
          password: ${{ secrets.DOCKER_HANADB_PASSWORD }}
      - name: Start Hana
        run: |
          mkdir ./HXE
          chmod 777 ./HXE
          HXE_VERSION=2.00.054.00.20210603.1
          echo "{\"master_password\" : \"L1qu1base_test\"}" > ./HXE/passwords.json
          chmod 777 ./HXE/passwords.json

          docker pull store/saplabs/hanaexpress:$HXE_VERSION

          docker run -d \
            -p 39013:39013 \
            -p 39015:39015 \
            -p 39017:39017 \
            -p 39041-39045:39041-39045 \
            -p 1128-1129:1128-1129 \
            -p 59013-59014:59013-59014 \
            -v $(pwd)/HXE:/hana/mounts \
            --ulimit nofile=1048576:1048576 \
            --sysctl kernel.shmmax=1073741824 \
            --sysctl net.ipv4.ip_local_port_range='40000 60999' \
            --sysctl kernel.shmall=8388608 \
            --name HXE \
            store/saplabs/hanaexpress:$HXE_VERSION \
            --passwords-url file:///hana/mounts/passwords.json \
            --agree-to-sap-license

          sleep 10

          timeout 500 sh -c '
            while true; do
              STARTING_CONTAINERS=`docker ps --filter "name=HXE" --format "{{.Names}} {{.Status}}" | grep "health: starting" | wc -l`;
              echo "Waiting for $STARTING_CONTAINERS HANA container(s) to finish startup";
              if [ $STARTING_CONTAINERS -ne 1 ]; then
                break;
              fi;
              sleep 5;
            done
          '

          docker ps -a
          docker logs HXE
          docker exec HXE bash -l -c "hdbsql -u SYSTEM -p L1qu1base_test -i 90 -d HXE 'CREATE USER LIQUIBASE_TEST PASSWORD L1qu1base_test NO FORCE_FIRST_PASSWORD_CHANGE'"

      - name: Run Integration Tests
        run: mvn -B verify

      - name: Archive Test Results
        if: ${{ always() }}
        uses: actions/upload-artifact@v2
        with:
          name: test-reports-integration
          path: target/failsafe-reports
