language: java
os: linux
services:
- docker
env:
  global:
  - HXE_VERSION=2.00.036.00.20190223.1
  - 'PASSWORD_FILE_CONTENT=''{"master_password" : "L1qu1base_test"}'''
  - PASSWORD_FILE_NAME=passwords.json
  - secure: SOo3ksHqLtKG0NwlIj//LCN4QTtvesZa0qGEJK/B1l+raCJXQJhN0p95z9hjeTiNnNCJ+AuCPxJVKPJaZamxjdLx0GxJ3PDEaUPnbtHDfWEvttkkh9XUC6+9nsvJUSekHoeqiff+K8c/tXqH4/dsZXPgrKFJfUV+yTQnfabyRfp9YJhS0JupAGxPXTAouTffsmvykhPaqEK9h6yD2mYdjMjWOjGWSu8Q0kiCI7r8IZJvZT5v8ROqmIj+IhD8HU4eoBDBr2/vNwb2fDZWsOLFcuLVpUHDIkCk56P9Gpzd+nKPZP2SPQ4SxUq57OUgjcUlcQA4id8hGi8qZxQjOMbCJVrUugEhU/VfpJ437tyn/UDnYI/Q1IpCyGdeDJ83lrYYspotUo6gCEPFfT3K2Z1bHYfiMAV03jTO8+zFCLPDNB3MfQJmfkT2BFhc8uL5+/oE8r4GSu2OB924jO3Go7ksIntNJ9zMLNitORgrJCdE/4PyrqDBxzxA7c7PIU83GVgwF3pnjJiOcRSeWdOaxA1RUzqpPUJ25XpHoS9WhjjbczOl84NqZ69rCzEepwkxDjj3tiaDQ3K3/Zdibgy6FrbDCafRv20wjwbwnAj4BrD8JN+hXl/AuKHLAZoXV6A347HHixu9lYB31i085GxvqXRKpcYjHANvvknKF07QXDypfIs=
  - secure: vIJE22oeVz1LONun2lOeQb/FvJKop2HOtuhuUY7xi1YBe8zooL14E79+fS5Vx6mtwjL55W/nVGqx+I1yXit3mNcECUvBy6v2oYMxW68y4wIG4SjtM7RM0ItsgQ8moulqRa6tkgmPALSgAZxaIUyMTYa8IijQLWwNj0PWqpi6PMX+3zhZvXpUFqnGnFLBuRtzM97wVGbDtrp19KhqAK0P7lNM4LotMt6suRTWQBEo3Q/0kVl51sKvj7O141Kf7zAMsu4wcjveiVn41k9PZ3qVCccx8wQUMf3Bi0OEtQbRNDx6h4gdrn0glAUtEgus9TnKyiAqso+xWOxY2rZnbJLiPdUzlei27QW9kjdgvzaHdxNAMhI+muMD9Cg9jZZ/EwUgm43uK1oyl6HhraUBjagsI6eZ4Zg1uWMOXgDBZ4s4k+HSDQkXBD0tYtFRgKtDN/bsiuayFGQv4O4hu51+EROZ0Tl3a8uIWqw9SCgjaJZN9y2+kY7d5wyGCKHJjrsCtyjzPEpFwAgCzU5lwdkrFuuIY+5gYw11Y21FIb982kUlrIvqen25HCfYXB4f8/dVEkglI7/46dEtG+3Vdu6SoxD/MuQi4y+WumkYJSOcZbiOqaL/Vf0ub6TAHEOaqaUQFZ9zM/u5LVwrxlty36gceXus1k2zozKvrBowHW4ecrvVIKY=
before_script:
- mkdir $TRAVIS_BUILD_DIR/HXE
- chmod -R 777 $TRAVIS_BUILD_DIR/HXE
- echo $PASSWORD_FILE_CONTENT > $TRAVIS_BUILD_DIR/HXE/$PASSWORD_FILE_NAME
- chmod 777 $TRAVIS_BUILD_DIR/HXE/$PASSWORD_FILE_NAME
- echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
- docker pull store/saplabs/hanaexpress:$HXE_VERSION
- docker run -d -p 39013:39013 -p 39015:39015 -p 39017:39017 -p 39041-39045:39041-39045
  -p 1128-1129:1128-1129 -p 59013-59014:59013-59014 -v $TRAVIS_BUILD_DIR/HXE:/hana/mounts
  --ulimit nofile=1048576:1048576 --sysctl kernel.shmmax=1073741824 --sysctl net.ipv4.ip_local_port_range='40000
  60999' --sysctl kernel.shmmni=524288 --sysctl kernel.shmall=8388608 --name HXETravisCI
  store/saplabs/hanaexpress:$HXE_VERSION --passwords-url file:///hana/mounts/$PASSWORD_FILE_NAME
  --agree-to-sap-license
- sleep 10
- "while true; do \n  STARTING_CONTAINERS=`docker ps --filter \"name=HXETravisCI\"
  --format \"{{.Names}} {{.Status}}\" | grep 'health: starting' | wc -l`;\n  echo
  \"Waiting for $STARTING_CONTAINERS HANA container(s) to finish startup\";\n  if
  [ $STARTING_CONTAINERS -ne 1 ]; then\n    break; \n  fi;\n  sleep 5; \ndone"
- docker ps -a
- docker exec HXETravisCI bash -l -c "hdbsql -u SYSTEM -p L1qu1base_test -i 90 -d
  HXE 'CREATE USER LIQUIBASE_TEST PASSWORD L1qu1base_test NO FORCE_FIRST_PASSWORD_CHANGE'"
- docker logout
addons:
  hosts:
  - hxehost
