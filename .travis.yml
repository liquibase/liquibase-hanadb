language: java
os: linux
services:
- docker
env:
  global:
  - HXE_VERSION=2.00.036.00.20190223.1
  - 'PASSWORD_FILE_CONTENT=''{"master_password" : "L1qu1base_test"}'''
  - PASSWORD_FILE_NAME=passwords.json
  #DOCKER_USERNAME
  - secure: "hbki7sRIy8pAJvNt+2mOAmur3NVxzXMfDf+JCzs8Nqs+EfanyU7bb2rcHBYybEbSfhTqkV1HxPce8ck20z2btapd1uqPgxz+b8FSTu64BD95D7ayGhZanFve6h1KiCJoxfnabn5/AyREtDHA/Y1uguWEj+Eg0E8mKeTzRKi0/5b3vCuYUuJUt03AkM79jq8crvaF2qKZuvI/e49ETERoDJrf/2bEa0gTJl7xPhy/HzyWlaJG0a/8jc8H0m6v8vteidcLlmmYL1vhacLBaxmzcvvtcr4XVNYHsPJiHvWnnEMgxxgz4L5CO9iF4mL4V4V7vtHlwRfy1OpnmElkIj1bLvtTgLca1yU4G9wT7CSLe5CNETdMeSP0ivMVbPhbPlpPliwUdn8XNM6gCBFq5GMyI/m58RH3VCJcQciGY3/RPn+a1oXJdOgGn4Lao0n87TAXAtsZ9XUfd4MmiPNxPyasURX2c3aNi+KDX6hurWlXZQ/Qq1nz17rMmwq4e83qWn9/Xd5oorEMHohnMZy1uNJUHKtB0eT03be7lJOJgBvwUrYF2pffUctagPrI0GH966sCk37x/Kvh1tzHskpSNCUH11Eyn5ep323UNDBXUcSyiHUmBDTIR3gKZpKYvvTXBYmfzUersc76g7qldORxJPk/fqWQoPlky8+Nb2i3sFPdryU="
  #DOCKER_PASSWORD
  - secure: "IvWA3tUciwyNVWaKywYB4WNCZidUgWoA53OgUnb0hTO1Lr4P5C0QPfwRvtK9ZUYnlsZg6dlt1kdmHKrBnP72DiOp0ZEKStjm21IJax19cYJ7AVuJWGD4mLJigkeUhXIFf1FUF8wpgDuY+E7arBdxGEddR9n3/kLhMPeEoKaeTXj5Qmh2TEthPuH4gtpJ8qwHIiPvECRj7FGarM2sHpS9d53jwqAmwjGu6ZTaav4+IaCb+ukJPBzE2ad0K9Dm4rtlwuyw3JGmYgXKRt41rF8QuJLPzUvlA8FmCODs8lWARujoVmUtVLYMSFo/OBunzJrNjd+Q6gH1iVwhsG3ki5qYn3zpzxMwLXLpxxxDraExdlc7PWIMIQ3RMlJLYk0FgtMmwaE0WDnCqFb2K75UtS8uaQ9mYhYUW8tjbl338ihDH8GfxHsHzOQVCB0NGpkZm/Ww3Dg3/5+0mLNICjxPRawzGwXVwfBoFs91glr2BXbg1OAPkidro1ejm2xlfFmgiJCBExuAif1kETySOVO2r1gHEqzlW0WxU7C2w3WCOyoX3ycwUZ9gA44gJYAGq7tMgMDS1zKK35wtxmdG47brkokA0kx6UBSk6a7u99/2soWhNtWRChrDrBxJ2wcPTw5Zbi5HeE810/fUDRWfBfNYKffccKpoaQnHfy/OFagZU1qUss0="  
before_script:
- mkdir $TRAVIS_BUILD_DIR/HXE
- chmod -R 777 $TRAVIS_BUILD_DIR/HXE
- echo $PASSWORD_FILE_CONTENT > $TRAVIS_BUILD_DIR/HXE/$PASSWORD_FILE_NAME
- chmod 777 $TRAVIS_BUILD_DIR/HXE/$PASSWORD_FILE_NAME
- echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
- docker pull store/saplabs/hanaexpress:$HXE_VERSION
- docker run -d -p 39013:39013 -p 39015:39015 -p 39017:39017 -p 39041-39045:39041-39045
  -p 1128-1129:1128-1129 -p 59013-59014:59013-59014 -v $TRAVIS_BUILD_DIR/HXE:/hana/mounts
  --ulimit nofile=1048576:1048576 --sysctl kernel.shmmax=1073741824 --sysctl net.ipv4.ip_local_port_range='40000
  60999' --sysctl kernel.shmmni=524288 --sysctl kernel.shmall=8388608 --name HXETravisCI
  store/saplabs/hanaexpress:$HXE_VERSION --passwords-url file:///hana/mounts/$PASSWORD_FILE_NAME
  --agree-to-sap-license
- sleep 10
- "while true; do \n  STARTING_CONTAINERS=`docker ps --filter \"name=HXETravisCI\"
  --format \"{{.Names}} {{.Status}}\" | grep 'health: starting' | wc -l`;\n  echo
  \"Waiting for $STARTING_CONTAINERS HANA container(s) to finish startup\";\n  if
  [ $STARTING_CONTAINERS -ne 1 ]; then\n    break; \n  fi;\n  sleep 5; \ndone"
- docker ps -a
- docker exec HXETravisCI bash -l -c "hdbsql -u SYSTEM -p L1qu1base_test -i 90 -d
  HXE 'CREATE USER LIQUIBASE_TEST PASSWORD L1qu1base_test NO FORCE_FIRST_PASSWORD_CHANGE'"
- docker logout
addons:
  hosts:
  - hxehost
